#!/bin/bash

# TIL (Today I Learned) markdown review hook
# Only reviews .md files in ~/dev/TIL directory
# Gemini reviews the document and passes feedback to Claude

ENABLE_TIL_REVIEW=${ENABLE_TIL_REVIEW:-0}

INPUT=$(cat)
FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // .tool_input.filePath // empty')

# Only review markdown files
if [[ ! "$FILE_PATH" =~ \.md$ ]] || [[ ! -f "$FILE_PATH" ]]; then
	exit 0
fi

# Skip GEMINI.md (context file, not a TIL document)
if [[ "$(basename "$FILE_PATH")" == "GEMINI.md" ]]; then
	exit 0
fi

# Check if file is under ~/dev/TIL
TIL_DIR="$HOME/dev/TIL"
if [[ ! "$FILE_PATH" =~ ^$TIL_DIR ]]; then
	exit 0
fi

# Exit if review is disabled
if [[ "$ENABLE_TIL_REVIEW" -ne 1 ]]; then
	exit 0
fi

# Model configuration
GEMINI_MODEL="gemini-3-flash-preview"

echo "ðŸ“ Gemini($GEMINI_MODEL)ê°€ TIL ë¬¸ì„œë¥¼ ë¦¬ë·° ì¤‘..." >&2

# TIL-specific review prompt
# --sandbox false: disable sandbox to avoid workspace restrictions
# TIL ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰: GEMINI.mdë¥¼ ìžë™ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ë¡œ ì½ìŒ
# grep -vë¡œ CLI ì‹œìž‘ ë¡œê·¸ ë° ì—ì´ì „íŠ¸ thinking ì¶œë ¥ í•„í„°ë§
REVIEW_OUTPUT=$(cd "$TIL_DIR" && cat "$FILE_PATH" | gemini -y --sandbox false -m "$GEMINI_MODEL" "ë‹¹ì‹ ì€ ê¼¼ê¼¼í•˜ê³  ê±´ì„¤ì ì¸ ê¸°ìˆ  ë¬¸ì„œ ê²€í†  ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.

**ì˜¤ëŠ˜ ë‚ ì§œ: $(date +%Y-%m-%d)** (Deprecated API íŒë‹¨ ê¸°ì¤€)

**ì¤‘ìš”: stdinìœ¼ë¡œ ì œê³µëœ ë‹¨ì¼ ë¬¸ì„œë§Œ ë¦¬ë·°í•˜ì„¸ìš”. íŒŒì¼ ì‹œìŠ¤í…œì˜ ë‹¤ë¥¸ íŒŒì¼ì„ íƒìƒ‰í•˜ì§€ ë§ˆì„¸ìš”. ë‹¨, ì‚¬ì‹¤ ê²€ì¦ì„ ìœ„í•œ ì›¹ ê²€ìƒ‰ì€ í—ˆìš©ë©ë‹ˆë‹¤.**

ì•„ëž˜ TIL(Today I Learned) ë¬¸ì„œë¥¼ ë¦¬ë·°í•´ì£¼ì„¸ìš”.

## TIL ë¬¸ì„œì˜ íŠ¹ì„± (ë°˜ë“œì‹œ ì´í•´í•˜ì„¸ìš”)
- **í•™ìŠµ ë…¸íŠ¸**ìž…ë‹ˆë‹¤. í”„ë¡œë•ì…˜ ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.
- ì˜ˆì‹œ ì½”ë“œì˜ ëª©ì ì€ **ê°œë… ì „ë‹¬**ìž…ë‹ˆë‹¤. ì™„ë²½í•œ ì˜ˆì™¸ ì²˜ë¦¬ë‚˜ ìŠ¤íƒ€ì¼ì€ ìš”êµ¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- \`throws Exception\`, ê°„ëžµí™”ëœ ì—ëŸ¬ ì²˜ë¦¬ ë“±ì€ **ì˜ë„ëœ ë‹¨ìˆœí™”**ìž…ë‹ˆë‹¤. ì§€ì í•˜ì§€ ë§ˆì„¸ìš”.

## ë¦¬ë·° ì² í•™: ê· í˜• ìž¡ížŒ í”¼ë“œë°±
- **ë¬¸ì œê°€ ìžˆì„ ë•Œë§Œ ì§€ì í•˜ì„¸ìš”.** ì–µì§€ë¡œ ê°œì„ ì ì„ ì°¾ì§€ ë§ˆì„¸ìš”.
- ì‚¬ì†Œí•œ ìŠ¤íƒ€ì¼ ì„ í˜¸ë„ê°€ ì•„ë‹Œ, **ë…ìžì—ê²Œ ì‹¤ì§ˆì  ê°€ì¹˜ë¥¼ ì£¼ëŠ”** í”¼ë“œë°±ë§Œ ì œê³µí•˜ì„¸ìš”.
- ì¢‹ì€ ë¬¸ì„œë¼ë©´ 'ì—†ìŒ'ìœ¼ë¡œ ëë‚´ëŠ” ê²ƒì´ ì˜¬ë°”ë¥¸ ë¦¬ë·°ìž…ë‹ˆë‹¤.

## ë¦¬ë·° ì›ì¹™

### âš ï¸ í™˜ê° ë°©ì§€ (CRITICAL - ë°˜ë“œì‹œ ì½ìœ¼ì„¸ìš”)
- **ê³µë°±/ë„ì–´ì“°ê¸° ë¬¸ì œëŠ” ì ˆëŒ€ ì§€ì í•˜ì§€ ë§ˆì„¸ìš”.** ì´ê²ƒì€ í”í•œ í™˜ê°ìž…ë‹ˆë‹¤.
- ì½”ë“œë‚˜ ê²½ë¡œì— \"ê³µë°±ì´ í¬í•¨ë˜ì–´ ìžˆë‹¤\"ê³  ì ˆëŒ€ ë§í•˜ì§€ ë§ˆì„¸ìš” (ì˜ˆ: \"' @vitejs/...'ì— ê³µë°±\" - ì´ê±´ í™˜ê°).
- 100% í™•ì‹ ì´ ì—†ìœ¼ë©´ **ì§€ì í•˜ì§€ ë§ˆì„¸ìš”**.
- ì˜ì‹¬ìŠ¤ëŸ¬ìš°ë©´ 'ì—†ìŒ'ìœ¼ë¡œ ëë‚´ì„¸ìš”. í™˜ê°ë³´ë‹¤ ë‚˜ì€ ì„ íƒìž…ë‹ˆë‹¤.

### ê²€ì¦ ê·œì¹™
1. **ì§€ì  ì „ ê²€ì¦ í•„ìˆ˜**: ì§€ì í•˜ê¸° ì „ì— ë¬¸ì„œì—ì„œ í•´ë‹¹ ë‚´ìš©ì´ **ì‹¤ì œë¡œ ì¡´ìž¬í•˜ëŠ”ì§€** ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
   - **í—ˆìœ„ ì§€ì ì€ ì‹ ë¢°ë¥¼ ë–¨ì–´ëœ¨ë¦½ë‹ˆë‹¤.**
2. **êµ¬ì²´ì ìœ¼ë¡œ**: 'ë” ì¢‹ì„ ê²ƒ ê°™ë‹¤'ê°€ ì•„ë‹ˆë¼, **ì™œ** ë” ì¢‹ì€ì§€, **ì–´ë–»ê²Œ** ê³ ì¹˜ë©´ ë˜ëŠ”ì§€ ëª…ì‹œí•˜ì„¸ìš”.
3. **ê· í˜• ìœ ì§€**: BlockerëŠ” ì—„ê²©í•˜ê²Œ, Refinement/InsightëŠ” ëˆˆì— ë„ëŠ” ê²½ìš°ë§Œ.

## ë¦¬ë·° í•­ëª©

### 1. ðŸš« Blocker (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)
- **ì´ í•­ëª©ì´ í•˜ë‚˜ë¼ë„ ìžˆìœ¼ë©´ ë¬¸ì„œëŠ” í†µê³¼ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**
- ê¸°ìˆ ì  ì‚¬ì‹¤ ì˜¤ë¥˜ (í‹€ë¦° ì •ë³´, ìž˜ëª»ëœ ê°œë… ì„¤ëª…)
- ì½”ë“œ ë¬¸ë²• ì˜¤ë¥˜ë¡œ ì¸í•´ **ì»´íŒŒì¼/ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥**í•œ ê²½ìš°
- Deprecated API ì‚¬ìš© (ëŒ€ì•ˆ ëª…ì‹œ í•„ìš”)

**Blockerê°€ ì•„ë‹Œ ê²ƒ:**
- ì˜ˆì‹œ ì½”ë“œì˜ ë‹¨ìˆœí™”ëœ ì˜ˆì™¸ ì²˜ë¦¬
- ìŠ¤íƒ€ì¼ ì„ í˜¸ë„ ì°¨ì´
- ë” ë‚˜ì€ ë°©ë²•ì´ ìžˆì„ ìˆ˜ ìžˆëŠ” ê²½ìš°
- ê°œë… ì„¤ëª…ì„ ìœ„í•œ ì˜ì‚¬ ì½”ë“œ(Pseudo-code)ì˜ ë¬¸ë²•

### 2. ðŸ’¡ Refinement (ê°œì„  ì œì•ˆ - ìˆ˜ì • ì„ íƒ)
- **ìžˆë‹¤ë©´ ìµœëŒ€ 1ê°œë§Œ.** ì–µì§€ë¡œ ì°¾ì§€ ë§ˆì„¸ìš”. ì—†ìœ¼ë©´ 'ì—†ìŒ'.
- ë…ìžì˜ ì´í•´ë„ë¥¼ ë†’ì´ê±°ë‚˜, ì„¤ëª…ì„ ë” ëª…í™•í•˜ê²Œ ë§Œë“œëŠ” ì œì•ˆ
- ëˆ„ë½ëœ ì¤‘ìš” ì •ë³´, ëª¨í˜¸í•œ ì„¤ëª…, ë…¼ë¦¬ì  ë¹„ì•½
- ì™¸ë¶€ URL ì¶œì²˜ ë§í¬ê°€ ê¹¨ì¡Œê±°ë‚˜ ëª…ë°±ížˆ ìž˜ëª»ëœ ê²½ìš° (ë¡œì»¬ íŒŒì¼ ë§í¬ëŠ” ê²€ì¦í•˜ì§€ ë§ˆì„¸ìš”)

**ì¢‹ì€ Refinement ì˜ˆì‹œ:**
- \"2.3ì ˆì—ì„œ X ê°œë…ì„ ì–¸ê¸‰í–ˆì§€ë§Œ ì •ì˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê°„ë‹¨í•œ ì„¤ëª…ì„ ì¶”ê°€í•˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.\"
- \"Before/After ë¹„êµì—ì„œ Afterê°€ ì™œ ë” ë‚˜ì€ì§€ ì´ìœ ê°€ ëª…ì‹œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\"
- \"ë‹¤ì´ì–´ê·¸ëž¨ê³¼ ë³¸ë¬¸ ì„¤ëª…ì´ ì•½ê°„ ë‹¤ë¦…ë‹ˆë‹¤. AëŠ” Bë¼ê³  í–ˆëŠ”ë° ë‹¤ì´ì–´ê·¸ëž¨ì—ì„œëŠ” Cë¡œ í‘œì‹œë¨.\"

**Refinementê°€ ì•„ë‹Œ ê²ƒ (ì ˆëŒ€ ì œì•ˆí•˜ì§€ ë§ˆì„¸ìš”):**
- ì˜ˆì‹œ ì½”ë“œì˜ ìŠ¤íƒ€ì¼ ê°œì„ 
- \`throws Exception\` â†’ êµ¬ì²´ì  ì˜ˆì™¸ ë³€ê²½
- shutdown() ë©”ì„œë“œ ì¶”ê°€, ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì½”ë“œ ì¶”ê°€
- ê°œì¸ì  ì„ í˜¸ë„ì— ê¸°ë°˜í•œ ì œì•ˆ

### 3. ðŸŽ“ Insight (ì‹¬í™” í•™ìŠµ - ìˆ˜ì • ë¶ˆí•„ìš”)
- **ìžˆë‹¤ë©´ ìµœëŒ€ 1ê°œë§Œ.** ë…ìžê°€ ë” ê¹Šì´ í•™ìŠµí•  ìˆ˜ ìžˆëŠ” ë°©í–¥ì„ ì œì‹œí•˜ì„¸ìš”. ì—†ìœ¼ë©´ 'ì—†ìŒ'.
- ê´€ë ¨ëœ ì‹¬í™” ì£¼ì œ, ì‹¤ë¬´ì—ì„œ ë§ˆì£¼ì¹  ìˆ˜ ìžˆëŠ” ìƒí™©, ë©´ì ‘ ì§ˆë¬¸
- ë¬¸ì„œ ë‚´ìš©ê³¼ ì—°ê²°ë˜ëŠ” êµ¬ì²´ì ì¸ ì¸ì‚¬ì´íŠ¸

**ì¢‹ì€ Insight ì˜ˆì‹œ:**
- \"ì´ íŒ¨í„´ì€ ì‹¤ë¬´ì—ì„œ X ìƒí™©ì— ìžì£¼ ì‚¬ìš©ë©ë‹ˆë‹¤. Y í”„ë ˆìž„ì›Œí¬ì˜ Z ê¸°ëŠ¥ê³¼ ë¹„êµí•´ë³´ë©´ ì¢‹ìŠµë‹ˆë‹¤.\"
- \"ë©´ì ‘ì—ì„œ 'Aì™€ Bì˜ ì°¨ì´ì 'ì´ ìžì£¼ ì¶œì œë©ë‹ˆë‹¤. ì´ ë¬¸ì„œì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì •ë¦¬í•´ë‘ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.\"

## ì‘ë‹µ í˜•ì‹
1. ê° í•­ëª©ë³„ë¡œ í”¼ë“œë°±ì„ ìž‘ì„±í•˜ì„¸ìš”. í•´ë‹¹ ì‚¬í•­ì´ ì—†ìœ¼ë©´ 'ì—†ìŒ'ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ë§ˆë¬´ë¦¬.
2. **Blockerê°€ 'ì—†ìŒ'ì´ë©´, ë§ˆì§€ë§‰ ì¤„ì— ë°˜ë“œì‹œ:** STATUS: PASS
3. í•œê¸€ë¡œ ë‹µë³€í•˜ì„¸ìš”.
4. **ê¹”ë”í•˜ê²Œ ëë‚´ì„¸ìš”. ë¶ˆí•„ìš”í•œ ì¹­ì°¬ì´ë‚˜ ìš”ì•½ì€ ìƒëžµí•˜ì„¸ìš”.**" 2>&1 | grep -v -E "^\[STARTUP\]|^YOLO mode|^Loaded cached|^I will |^Error executing tool")

# Pass Gemini's review to Claude via stderr
cat >&2 <<EOF

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ¤– Gemini ($GEMINI_MODEL) TIL Review
ðŸ“„ File: $FILE_PATH
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

$REVIEW_OUTPUT

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ìœ„ Gemini ë¦¬ë·°ë¥¼ ì°¸ê³ í•˜ì—¬ ë¬¸ì„œë¥¼ ê°œì„ í•´ì£¼ì„¸ìš”.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EOF

# Exit with code 2 so Claude processes the stderr output
exit 2
