#!/bin/bash

# TIL (Today I Learned) markdown review hook
# Only reviews .md files in ~/dev/TIL directory
# Gemini reviews the document and passes feedback to Claude

ENABLE_GEMINI_REVIEW=${ENABLE_GEMINI_REVIEW:-0}

INPUT=$(cat)
FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // .tool_input.filePath // empty')

# Only review markdown files
if [[ ! "$FILE_PATH" =~ \.md$ ]] || [[ ! -f "$FILE_PATH" ]]; then
	exit 0
fi

# Skip GEMINI.md (context file, not a TIL document)
if [[ "$(basename "$FILE_PATH")" == "GEMINI.md" ]]; then
	exit 0
fi

# Check if file is under ~/dev/TIL
TIL_DIR="$HOME/dev/TIL"
if [[ ! "$FILE_PATH" =~ ^$TIL_DIR ]]; then
	exit 0
fi

# Exit if review is disabled
if [[ "$ENABLE_GEMINI_REVIEW" -ne 1 ]]; then
	exit 0
fi

# GEMINI.md ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± (TIL ë””ë ‰í† ë¦¬ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ /tmpì—ì„œë„ ì‚¬ìš©)
if [[ -f "$TIL_DIR/GEMINI.md" ]]; then
	ln -sf "$TIL_DIR/GEMINI.md" /tmp/GEMINI.md 2>/dev/null
fi

echo "ðŸ“ Geminiê°€ TIL ë¬¸ì„œë¥¼ ë¦¬ë·° ì¤‘..." >&2

# TIL-specific review prompt
# -m gemini-2.5-pro: best available model for thorough review
# --sandbox false: disable sandbox to avoid workspace restrictions
# /tmpì—ì„œ ì‹¤í–‰í•˜ì—¬ Geminiê°€ TIL ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡ì„ ì»¨í…ìŠ¤íŠ¸ì— í¬í•¨ì‹œí‚¤ì§€ ì•Šë„ë¡ í•¨
# (íŒŒì¼ ê²½ë¡œë¥¼ Java ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì˜¤í•´í•˜ëŠ” í™˜ê° ë°©ì§€)
REVIEW_OUTPUT=$(cd /tmp && cat "$FILE_PATH" | gemini -y --sandbox false -m gemini-2.5-pro "ë‹¹ì‹ ì€ ì •í™•í•˜ê³  íš¨ìœ¨ì ì¸ ê¸°ìˆ  ë¬¸ì„œ ê²€í†  ì „ë¬¸ê°€ìž…ë‹ˆë‹¤. ì•„ëž˜ TIL(Today I Learned) ë¬¸ì„œë¥¼ ë¦¬ë·°í•´ì£¼ì„¸ìš”.

## TIL ë¬¸ì„œì˜ íŠ¹ì„± (ë°˜ë“œì‹œ ì´í•´í•˜ì„¸ìš”)
- **í•™ìŠµ ë…¸íŠ¸**ìž…ë‹ˆë‹¤. í”„ë¡œë•ì…˜ ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.
- ì˜ˆì‹œ ì½”ë“œì˜ ëª©ì ì€ **ê°œë… ì „ë‹¬**ìž…ë‹ˆë‹¤. ì™„ë²½í•œ ì˜ˆì™¸ ì²˜ë¦¬ë‚˜ ìŠ¤íƒ€ì¼ì€ ìš”êµ¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- \`throws Exception\`, ê°„ëžµí™”ëœ ì—ëŸ¬ ì²˜ë¦¬ ë“±ì€ **ì˜ë„ëœ ë‹¨ìˆœí™”**ìž…ë‹ˆë‹¤. ì§€ì í•˜ì§€ ë§ˆì„¸ìš”.

## ë¦¬ë·° ì² í•™: ìµœì†Œ ê°œìž… ì›ì¹™
- **ì´ë¯¸ ì¶©ë¶„ížˆ ì¢‹ì€ ë¬¸ì„œë¼ë©´, êµ³ì´ ê°œì„ ì ì„ ì°¾ìœ¼ë ¤ í•˜ì§€ ë§ˆì„¸ìš”.**
- ë¦¬ë·°ì–´ì˜ ì—­í• ì€ 'ë” ì¢‹ê²Œ ë§Œë“¤ê¸°'ê°€ ì•„ë‹ˆë¼ 'ë¬¸ì œê°€ ìžˆëŠ”ì§€ í™•ì¸'ìž…ë‹ˆë‹¤.
- ë§¤ë²ˆ ìƒˆë¡œìš´ ì œì•ˆì„ ë§Œë“¤ì–´ë‚´ë©´ ëì´ ì—†ìŠµë‹ˆë‹¤. **ì •ë§ ì¤‘ìš”í•œ ê²ƒë§Œ** ì§€ì í•˜ì„¸ìš”.

## ë¦¬ë·° ì›ì¹™
1. **ì§€ì  ì „ ê²€ì¦ í•„ìˆ˜**: ì§€ì í•˜ê¸° ì „ì— ë¬¸ì„œì—ì„œ í•´ë‹¹ ë‚´ìš©ì´ **ì‹¤ì œë¡œ ì¡´ìž¬í•˜ëŠ”ì§€** ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
   - ì˜ˆ: ê³µë°±ì´ ìžˆë‹¤ê³  ì§€ì í•˜ë ¤ë©´, ì‹¤ì œë¡œ ê·¸ ìœ„ì¹˜ì— ê³µë°±ì´ ìžˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
   - **í—ˆìœ„ ì§€ì ì€ ì‹ ë¢°ë¥¼ ë–¨ì–´ëœ¨ë¦½ë‹ˆë‹¤.**
2. **ì§„ì§œ ë¬¸ì œë§Œ ì§€ì **: ì‚¬ì†Œí•œ ìŠ¤íƒ€ì¼ ì„ í˜¸ë„ë‚˜ 'ë” ë‚˜ì„ ìˆ˜ë„ ìžˆëŠ”' ì œì•ˆì€ í•˜ì§€ ë§ˆì„¸ìš”.
3. **ê°„ê²°í•˜ê²Œ**: ì§€ì í•  ê²Œ ì—†ìœ¼ë©´ 'ì—†ìŒ'ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ëë‚´ì„¸ìš”.

## ë¦¬ë·° í•­ëª©

### 1. ðŸš« Blocker (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)
- **ì´ í•­ëª©ì´ í•˜ë‚˜ë¼ë„ ìžˆìœ¼ë©´ ë¬¸ì„œëŠ” í†µê³¼ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**
- ê¸°ìˆ ì  ì‚¬ì‹¤ ì˜¤ë¥˜ (í‹€ë¦° ì •ë³´, ìž˜ëª»ëœ ê°œë… ì„¤ëª…)
- ì½”ë“œ ë¬¸ë²• ì˜¤ë¥˜ë¡œ ì¸í•´ **ì»´íŒŒì¼/ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥**í•œ ê²½ìš°
- Deprecated API ì‚¬ìš© (ëŒ€ì•ˆ ëª…ì‹œ í•„ìš”)

**mermaid ë¬¸ë²• ê²€ì¦ (Blocker):**
mermaid ì½”ë“œ ë¸”ë¡ì´ ìžˆë‹¤ë©´ ë‹¤ìŒ í”í•œ ì˜¤ë¥˜ íŒ¨í„´ì„ ì²´í¬í•˜ì„¸ìš”:
- ëŒ€ê´„í˜¸ ì¤‘ì²©: \`[\"[...]\"]\" í˜•íƒœëŠ” íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ
- subgraph ë ˆì´ë¸”ì—ì„œ ëŒ€ê´„í˜¸ì™€ ë‚´ë¶€ ë…¸ë“œ ì¶©ëŒ
- ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ ëˆ„ë½
- í™”ì‚´í‘œ ë¬¸ë²• ì˜¤ë¥˜ (\`-->\`, \`-->\|label\|\` ë“±)
- **ì¤„ë°”ê¿ˆ ë¬¸ë²• ì˜¤ë¥˜**: \`\\n\`ì€ mermaidì—ì„œ í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥ë¨. ì¤„ë°”ê¿ˆì€ HTML BR íƒœê·¸ ì‚¬ìš©
  - âŒ Bad: \`["ì²«ì§¸ ì¤„\\në‘˜ì§¸ ì¤„"]\` â†’ "\\n"ì´ ê·¸ëŒ€ë¡œ ì¶œë ¥
  - âœ… Good: \`["ì²«ì§¸ ì¤„ + BRíƒœê·¸ + ë‘˜ì§¸ ì¤„"]\` â†’ ì •ìƒ ì¤„ë°”ê¿ˆ (BRíƒœê·¸ = êº¾ì‡ brêº¾ì‡ )
ì´ëŸ° ì˜¤ë¥˜ê°€ ìžˆìœ¼ë©´ Blockerë¡œ ì§€ì í•˜ì„¸ìš”.

**Blockerê°€ ì•„ë‹Œ ê²ƒ:**
- ì˜ˆì‹œ ì½”ë“œì˜ ë‹¨ìˆœí™”ëœ ì˜ˆì™¸ ì²˜ë¦¬
- ìŠ¤íƒ€ì¼ ì„ í˜¸ë„ ì°¨ì´
- ë” ë‚˜ì€ ë°©ë²•ì´ ìžˆì„ ìˆ˜ ìžˆëŠ” ê²½ìš°

### 2. ðŸ’¡ Refinement (ê°œì„  ì œì•ˆ - ìˆ˜ì • ì„ íƒ)
- **ìµœëŒ€ 1ê°œë§Œ ìž‘ì„±í•˜ì„¸ìš”. ì—†ìœ¼ë©´ ë°˜ë“œì‹œ 'ì—†ìŒ'.**
- ì •ë§ ì¤‘ìš”í•˜ê³ , ë…ìžì˜ ì´í•´ì— **ì‹¤ì§ˆì  ì˜í–¥**ì„ ë¯¸ì¹˜ëŠ” ê²½ìš°ë§Œ
- ì¶œì²˜ ë§í¬ê°€ ê¹¨ì¡Œê±°ë‚˜ ëª…ë°±ížˆ ìž˜ëª»ëœ ê²½ìš°

**Refinementê°€ ì•„ë‹Œ ê²ƒ (ì ˆëŒ€ ì œì•ˆí•˜ì§€ ë§ˆì„¸ìš”):**
- ì˜ˆì‹œ ì½”ë“œì˜ ìŠ¤íƒ€ì¼ ê°œì„ 
- \`throws Exception\` â†’ êµ¬ì²´ì  ì˜ˆì™¸ ë³€ê²½
- shutdown() ë©”ì„œë“œ ì¶”ê°€, ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì½”ë“œ ì¶”ê°€
- 'ì´ê²ƒë„ ì¶”ê°€í•˜ë©´ ì¢‹ê² ë‹¤' ë¥˜ì˜ í™•ìž¥ ì œì•ˆ
- ê°œì¸ì  ì„ í˜¸ë„ì— ê¸°ë°˜í•œ ì œì•ˆ

### 3. ðŸŽ“ Insight (ì‹¬í™” í•™ìŠµ - ìˆ˜ì • ë¶ˆí•„ìš”)
- **ìµœëŒ€ 1ê°œë§Œ ìž‘ì„±í•˜ì„¸ìš”. ì—†ìœ¼ë©´ 'ì—†ìŒ'.**
- ì •ë§ ìœ ì˜ë¯¸í•œ ì‹¬í™” ì£¼ì œë‚˜ ë©´ì ‘ ì§ˆë¬¸ë§Œ

## ì‘ë‹µ í˜•ì‹
1. ê° í•­ëª©ë³„ë¡œ í”¼ë“œë°±ì„ ìž‘ì„±í•˜ì„¸ìš”. í•´ë‹¹ ì‚¬í•­ì´ ì—†ìœ¼ë©´ 'ì—†ìŒ'ìœ¼ë¡œ í‘œê¸°.
2. **Blockerê°€ 'ì—†ìŒ'ì´ë©´, ë§ˆì§€ë§‰ ì¤„ì— ë°˜ë“œì‹œ:** STATUS: PASS
3. í•œê¸€ë¡œ ë‹µë³€í•˜ì„¸ìš”.
4. **ê¹”ë”í•˜ê²Œ ëë‚´ì„¸ìš”. ë¶ˆí•„ìš”í•œ ì¹­ì°¬ì´ë‚˜ ìš”ì•½ì€ ìƒëžµí•˜ì„¸ìš”.**" 2>&1)

# Pass Gemini's review to Claude via stderr
cat >&2 <<EOF

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ¤– Gemini TIL Review
ðŸ“„ File: $FILE_PATH
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

$REVIEW_OUTPUT

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ìœ„ Gemini ë¦¬ë·°ë¥¼ ì°¸ê³ í•˜ì—¬ ë¬¸ì„œë¥¼ ê°œì„ í•´ì£¼ì„¸ìš”.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EOF

# Exit with code 2 so Claude processes the stderr output
exit 2
